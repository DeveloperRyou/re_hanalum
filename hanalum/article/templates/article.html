{% extends "nav.html" %}

{% load static %}

{% block css %}
<link href="{% static 'css/article.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
  <div class="my-3 p-3 bg-white rounded shadow-sm">
    <h4 class="pb-2 mb-0 border-bottom border-gray">{{article.title}}</h4>
    <div class="media pt-3 main-text">
      <div class="media-body pb-3 mb-0 lh-125">
        {{article.content | safe }}
      </div>
    </div>

    <div class="media-body">
      {% if article.file_1 %}
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="{{article.file_1}}" disabled/>
            <a href="/media/{{article.file_1}}" download>
              <div class="input-group-append">
                <span class="input-group-text">download</span>
              </div>
            </a>
        </div>
      {% endif %}
      {% if article.file_2 %}
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="{{article.file_2}}" disabled/>
            <a href="/media/{{article.file_2}}" download>
              <div class="input-group-append">
                <span class="input-group-text">download</span>
              </div>
            </a>
        </div>
      {% endif %}
      {% if article.file_3 %}
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="{{article.file_3}}" disabled/>
            <a href="/media/{{article.file_3}}" download>
              <div class="input-group-append">
                <span class="input-group-text">download</span>
              </div>
            </a>
        </div>
      {% endif %}
    </div>

    <div class="media-body d-flex justify-content-center">
      <li>
      <input type="button" class="btn btn-primary like", name = "{{article.pk}}", value="추천", id="pk">
      <p id="count-{{ article.id }}">{{ article.like_count}}개</p>
      </li>
      <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
      <script type="text/javascript">
      $(".like").click(function(){
        var pk = $(this).attr('name')
        $.ajax({ // .like 버튼을 클릭하면 <새로고침> 없이 ajax로 서버와 통신하겠다.
          type: "POST", // 데이터를 전송하는 방법을 지정
          url: "{% url 'article_like' %}", // 통신할 url을 지정
          data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // 서버로 데이터 전송시 옵션
          dataType: "json", // 서버측에서 전송한 데이터를 어떤 형식의 데이터로서 해석할 것인가를 지정, 없으면 알아서 판단
      // 서버측에서 전송한 Response 데이터 형식 (json)
      //{'like_count': article.like_count, 'message': message }
          success: function(response){ // 통신 성공시 - 동적으로 좋아요 갯수 변경, 유저 목록 변경
            alert(response.message);
            $("#count-"+pk).html(response.like_count+"개");
            var users = $("#like-user-"+pk).text();
          },
          error: function(request, status, error){ // 통신 실패시 - 로그인 페이지 리다이렉트
            alert("로그인이 필요합니다.")
            window.location.replace(""+pk)
        //  alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
          },
        });
      });
    </script>
      <li>
      <input type="button" class="btn btn-outline-primary dislike", name = "{{article.pk}}", value="비추천", id="pk">
      <p id="count-{{ article.id }}">{{ article.dislike_count}}개</p>
      </li>
      <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
      <script type="text/javascript">
      $(".dislike").click(function(){
        var pk = $(this).attr('name')
        $.ajax({ // .like 버튼을 클릭하면 <새로고침> 없이 ajax로 서버와 통신하겠다.
          type: "POST", // 데이터를 전송하는 방법을 지정
          url: "{% url 'article_dislike' %}", // 통신할 url을 지정
          data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // 서버로 데이터 전송시 옵션
          dataType: "json", // 서버측에서 전송한 데이터를 어떤 형식의 데이터로서 해석할 것인가를 지정, 없으면 알아서 판단
      // 서버측에서 전송한 Response 데이터 형식 (json)
      //{'dislike_count': article.dislike_count, 'message': message }
          success: function(response){ // 통신 성공시 - 동적으로 좋아요 갯수 변경, 유저 목록 변경
            alert(response.messages);
            $("#count-"+pk).html(response.dislike_count+"개");
            var users = $("#dislike-user-"+pk).text();
          },
          error: function(request, status, error){ // 통신 실패시 - 로그인 페이지 리다이렉트
            alert("로그인이 필요합니다.비추천")
            window.location.replace(""+pk)
        //  alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
          },
        });
      });
    </script>
    </div>


    <div class="d-block text-right pb-3 border-bottom border-gray">
      <a href="#">수정</a>
      <a href="#">삭제</a>
      <a href="#">목록으로</a>
    </div>

    <h6 class="pb-2 pt-3">댓글</h6>
    {% for comment in article.comments.all %}
      <div class="media border pb-3 mb-4">
        <img src="{% static 'images/no-profile.png' %}" alt="John Doe" class="mr-3 mt-3 rounded-circle" style="width:60px;">
        <div class="media-body">
          <h4>{{ comment.writer.nickname }}<small><i>{{ comment.created_at }}</i></small></h4>
          <p>{{ comment.content }}</p>
        </div>
      </div>
    {% empty %}
      <p>아직 댓글이 없습니다.</p>
    {% endfor %}
    <h6 class="pb-2 pt-3 mt-3 border-top border-gray">댓글 작성</h6>

    <div class="media pb-2">
      <div class="media-body">
        <form action="" method="POST">
          {% csrf_token %}
          {{ form }}
          <input type="submit" value="등록" class="btn btn-success float-right">
        </form>
      </div>
    </div>

  </div>

{% endblock %}
